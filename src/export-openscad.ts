import { saveAs } from 'file-saver';
import { PartListImage } from './image-utils';
import { Export3DSettings } from './export-3mf';

interface JSZipFile {
    file(name: string, data: string | Blob, options?: { base64?: boolean }): void;
    generateAsync(options: { type: 'blob' }): Promise<Blob>;
}

interface JSZipConstructor {
    new(): JSZipFile;
}

/**
 * Generate OpenSCAD masks format: a zip file containing:
 * - One black/white PNG per color showing which pixels are filled
 * - An OpenSCAD file that loads images as heightmaps and combines them
 */
export async function generateOpenSCADMasks(image: PartListImage, settings: Export3DSettings): Promise<void> {
    const { pixels, partList, width, height } = image;
    const { pitch, filename } = settings;
    
    // We'll use JSZip if available, otherwise create a simple implementation
    const JSZip = await loadJSZip();
    const zip = new JSZip();
    
    // Generate one mask image per color
    const maskFiles: string[] = [];
    
    partList.forEach((part, colorIndex) => {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        
        if (!ctx) return;
        
        // Fill with white background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, width, height);
        
        // Draw black pixels where this color appears
        ctx.fillStyle = '#000000';
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                if (pixels[y][x] === colorIndex) {
                    ctx.fillRect(x, y, 1, 1);
                }
            }
        }
        
        // Convert canvas to blob
        const dataUrl = canvas.toDataURL('image/png');
        const base64Data = dataUrl.split(',')[1];
        
        const maskFilename = `mask_${colorIndex}_${sanitizeFilename(part.target.name)}.png`;
        maskFiles.push(maskFilename);
        
        zip.file(maskFilename, base64Data, { base64: true });
    });
    
    // Generate OpenSCAD file
    let scadContent = '// Generated by firaga.io\n';
    scadContent += '// 3D representation of pixel art using heightmap masks\n\n';
    scadContent += `// Dimensions\n`;
    scadContent += `pixel_size = ${pitch}; // mm per pixel\n`;
    scadContent += `pixel_height = ${pitch}; // height of each pixel layer\n`;
    scadContent += `img_width = ${width};\n`;
    scadContent += `img_height = ${height};\n\n`;
    
    scadContent += `// Color definitions\n`;
    partList.forEach((part, colorIndex) => {
        const r = part.target.r / 255;
        const g = part.target.g / 255;
        const b = part.target.b / 255;
        scadContent += `color_${colorIndex} = [${r.toFixed(3)}, ${g.toFixed(3)}, ${b.toFixed(3)}];\n`;
    });
    scadContent += '\n';
    
    scadContent += `// Render all layers\n`;
    scadContent += `union() {\n`;
    
    maskFiles.forEach((maskFile, colorIndex) => {
        scadContent += `  color(color_${colorIndex}) {\n`;
        scadContent += `    scale([pixel_size, pixel_size, pixel_height]) {\n`;
        scadContent += `      surface(file="${maskFile}", center=false, invert=true);\n`;
        scadContent += `    }\n`;
        scadContent += `  }\n`;
    });
    
    scadContent += `}\n`;
    
    zip.file(`${filename}.scad`, scadContent);
    
    // Generate README
    const readme = `3D Pixel Art Export from firaga.io

This archive contains:
- ${maskFiles.length} mask image(s), one per color
- An OpenSCAD file (${filename}.scad) that combines them into a 3D model

To use:
1. Install OpenSCAD (https://openscad.org/)
2. Open ${filename}.scad in OpenSCAD
3. Press F5 to preview or F6 to render
4. Export to STL for 3D printing (File > Export > Export as STL)

Each mask image shows which pixels use a particular color (black = present, white = absent).
The OpenSCAD file uses these as heightmaps to create colored 3D layers.

Dimensions:
- Pixel size: ${pitch}mm
- Overall size: ${(width * pitch).toFixed(1)}mm Ã— ${(height * pitch).toFixed(1)}mm
- Pixel height: ${pitch}mm
`;
    
    zip.file('README.txt', readme);
    
    // Generate and download zip
    const blob = await zip.generateAsync({ type: 'blob' });
    saveAs(blob, `${filename}_openscad.zip`);
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-zA-Z0-9_-]/g, '_');
}

/**
 * Load JSZip library dynamically
 */
async function loadJSZip(): Promise<JSZipConstructor> {
    // Check if already loaded
    if ((window as any).JSZip) {
        return (window as any).JSZip;
    }
    
    // Load from CDN
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        script.onload = () => {
            resolve((window as any).JSZip);
        };
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
