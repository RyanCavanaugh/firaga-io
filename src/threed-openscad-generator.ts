import { saveAs } from 'file-saver';
import { PartListImage } from './image-utils';
import { colorEntryToHex } from './utils';

export async function generateOpenSCADMasks(image: PartListImage, filename: string): Promise<void> {
    // Create a mask for each color and the OpenSCAD script
    const scadContent = generateOpenSCADScript(image, filename);
    const scadBlob = new Blob([scadContent], { type: 'text/plain' });
    
    // Save the .scad file
    saveAs(scadBlob, `${filename.replace(/\.[^.]+$/, '')}.scad`);
    
    // Create and save mask images for each color
    const maskPromises = image.partList.map((part, colorIndex) => {
        return createMaskImage(image, colorIndex, filename);
    });
    
    await Promise.all(maskPromises);
    
    // Inform user
    const totalFiles = image.partList.length + 1;
    alert(`Exported ${totalFiles} files:\n- 1 OpenSCAD file (.scad)\n- ${image.partList.length} mask images (.png)\n\nPlace all files in the same directory and open the .scad file in OpenSCAD.`);
}

async function createMaskImage(image: PartListImage, colorIndex: number, baseFilename: string): Promise<void> {
    return new Promise<void>((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = image.width;
        canvas.height = image.height;
        const ctx = canvas.getContext('2d');
        
        if (!ctx) {
            resolve();
            return;
        }
        
        // Fill with white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw black pixels where this color appears
        ctx.fillStyle = 'black';
        for (let y = 0; y < image.height; y++) {
            for (let x = 0; x < image.width; x++) {
                if (image.pixels[y][x] === colorIndex) {
                    ctx.fillRect(x, y, 1, 1);
                }
            }
        }
        
        // Convert canvas to blob and save
        canvas.toBlob((blob) => {
            if (blob) {
                const colorName = image.partList[colorIndex].target.name.replace(/[^a-zA-Z0-9]/g, '_');
                saveAs(blob, `${baseFilename.replace(/\.[^.]+$/, '')}_${colorName}.png`);
            }
            resolve();
        }, 'image/png');
    });
}

function generateOpenSCADScript(image: PartListImage, filename: string): string {
    const pixelSize = 1.0; // mm per pixel
    const baseHeight = 0.5; // base thickness
    const layerHeight = 1.0; // height per color layer
    const baseFilename = filename.replace(/\.[^.]+$/, '');
    
    const lines: string[] = [];
    
    lines.push('// Generated by firaga.io');
    lines.push('// 3D pixel art from image masks');
    lines.push('');
    lines.push('// Adjust these parameters as needed');
    lines.push(`pixel_size = ${pixelSize}; // mm per pixel`);
    lines.push(`base_height = ${baseHeight}; // mm`);
    lines.push(`layer_height = ${layerHeight}; // mm per layer`);
    lines.push('');
    lines.push('// Image dimensions');
    lines.push(`width = ${image.width};`);
    lines.push(`height = ${image.height};`);
    lines.push('');
    
    lines.push('// Combine all color layers');
    lines.push('union() {');
    
    image.partList.forEach((part, index) => {
        const colorName = part.target.name.replace(/[^a-zA-Z0-9]/g, '_');
        const hex = colorEntryToHex(part.target);
        
        lines.push(`  // ${part.target.name} (${hex})`);
        lines.push(`  color("${hex}")`);
        lines.push(`  surface(file = "${baseFilename}_${colorName}.png", center = true, invert = true)`);
        lines.push(`    scale([pixel_size, pixel_size, layer_height])`);
        lines.push(`    translate([0, 0, base_height]);`);
        lines.push('');
    });
    
    lines.push('}');
    lines.push('');
    lines.push('// Note: Place all PNG mask files in the same directory as this .scad file');
    
    return lines.join('\n');
}
