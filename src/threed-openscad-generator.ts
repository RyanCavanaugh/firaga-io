import { PartListImage } from "./image-utils";
import { colorEntryToHex } from "./utils";
import { saveAs } from "file-saver";

declare const JSZip: any;

export async function generateOpenSCADMasks(image: PartListImage, filename: string): Promise<void> {
    await loadJSZip();
    
    const zip = new JSZip();
    const scadLines: string[] = [];
    
    scadLines.push('// Generated by firaga.io');
    scadLines.push('// OpenSCAD heightmap visualization');
    scadLines.push('');
    scadLines.push('pixel_size = 1;');
    scadLines.push('height_scale = 2;');
    scadLines.push('');
    
    for (let partIdx = 0; partIdx < image.partList.length; partIdx++) {
        const part = image.partList[partIdx];
        const colorHex = colorEntryToHex(part.target);
        const maskFilename = `mask_${partIdx}_${sanitizeFilename(part.target.name)}.png`;
        
        const maskImage = createMaskImage(image, partIdx);
        zip.file(maskFilename, maskImage.split(',')[1], { base64: true });
        
        const r = parseInt(colorHex.substring(1, 3), 16) / 255;
        const g = parseInt(colorHex.substring(3, 5), 16) / 255;
        const b = parseInt(colorHex.substring(5, 7), 16) / 255;
        
        scadLines.push(`// ${part.target.name} (${part.count} pixels)`);
        scadLines.push(`color([${r.toFixed(3)}, ${g.toFixed(3)}, ${b.toFixed(3)}])`);
        scadLines.push(`  scale([pixel_size, pixel_size, height_scale])`);
        scadLines.push(`    surface(file = "${maskFilename}", center = true, invert = true);`);
        scadLines.push('');
    }
    
    zip.file(`${filename}.scad`, scadLines.join('\n'));
    
    const content = await zip.generateAsync({ type: 'blob' });
    saveAs(content, `${filename}_openscad.zip`);
}

function createMaskImage(image: PartListImage, partIdx: number): string {
    const canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    const ctx = canvas.getContext('2d');
    
    if (!ctx) {
        throw new Error('Could not get canvas context');
    }
    
    const imageData = ctx.createImageData(image.width, image.height);
    
    for (let y = 0; y < image.height; y++) {
        for (let x = 0; x < image.width; x++) {
            const idx = (y * image.width + x) * 4;
            const pixelValue = image.pixels[y][x] === partIdx ? 255 : 0;
            
            imageData.data[idx] = pixelValue;
            imageData.data[idx + 1] = pixelValue;
            imageData.data[idx + 2] = pixelValue;
            imageData.data[idx + 3] = 255;
        }
    }
    
    ctx.putImageData(imageData, 0, 0);
    return canvas.toDataURL('image/png');
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}

async function loadJSZip(): Promise<void> {
    return new Promise((resolve, reject) => {
        const tagName = "jszip-script-tag";
        const scriptEl = document.getElementById(tagName);
        
        if (scriptEl !== null) {
            resolve();
            return;
        }
        
        const tag = document.createElement("script");
        tag.id = tagName;
        tag.onload = () => resolve();
        tag.onerror = () => reject(new Error('Failed to load JSZip'));
        tag.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
        document.head.appendChild(tag);
    });
}
