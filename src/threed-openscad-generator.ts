import { PartListImage } from "./image-utils";
import { colorEntryToHex } from "./utils";

declare const JSZip: any;
declare const saveAs: any;

export async function makeOpenSCADMasks(image: PartListImage, filename: string) {
    // Dynamically load JSZip if not already loaded
    await loadJSZip();
    
    const zip = new JSZip();
    
    // Generate one black/white image per color
    image.partList.forEach((part, colorIdx) => {
        const maskImage = generateMaskImage(image, colorIdx);
        const pngData = maskImage.split(',')[1]; // Remove data:image/png;base64, prefix
        zip.file(`mask_${colorIdx}_${sanitizeFilename(part.target.name)}.png`, pngData, { base64: true });
    });
    
    // Generate the OpenSCAD file
    const scadContent = generateOpenSCADFile(image);
    zip.file(`${filename}.scad`, scadContent);
    
    // Generate the zip file and download it
    zip.generateAsync({ type: "blob" }).then((blob: Blob) => {
        if (typeof saveAs !== "undefined") {
            saveAs(blob, `${filename}_openscad.zip`);
        } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${filename}_openscad.zip`;
            a.click();
            URL.revokeObjectURL(url);
        }
    });
}

function generateMaskImage(image: PartListImage, colorIdx: number): string {
    const canvas = document.createElement("canvas");
    canvas.width = image.width;
    canvas.height = image.height;
    const ctx = canvas.getContext("2d")!;
    
    // Fill with white background
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, image.width, image.height);
    
    // Draw black pixels where this color appears
    ctx.fillStyle = "black";
    for (let y = 0; y < image.height; y++) {
        for (let x = 0; x < image.width; x++) {
            if (image.pixels[y][x] === colorIdx) {
                ctx.fillRect(x, y, 1, 1);
            }
        }
    }
    
    return canvas.toDataURL("image/png");
}

function generateOpenSCADFile(image: PartListImage): string {
    let scad = '// OpenSCAD file for 3D visualization\n';
    scad += '// Generated by firaga.io\n\n';
    scad += `width = ${image.width};\n`;
    scad += `height = ${image.height};\n`;
    scad += 'pixel_size = 1.0; // Size of each pixel in mm\n';
    scad += 'layer_height = 2.0; // Height of each layer in mm\n\n';
    
    scad += 'module display_layer(filename, color_rgb, z_offset) {\n';
    scad += '    color(color_rgb)\n';
    scad += '    translate([0, 0, z_offset])\n';
    scad += '    scale([pixel_size, pixel_size, layer_height])\n';
    scad += '    surface(file=filename, center=false, invert=true);\n';
    scad += '}\n\n';
    
    scad += '// Display all layers\n';
    scad += 'union() {\n';
    
    image.partList.forEach((part, colorIdx) => {
        const hex = colorEntryToHex(part.target);
        const rgb = hexToRgb(hex);
        const maskFilename = `mask_${colorIdx}_${sanitizeFilename(part.target.name)}.png`;
        scad += `    display_layer("${maskFilename}", [${rgb.r / 255}, ${rgb.g / 255}, ${rgb.b / 255}], ${colorIdx * 2.1}); // ${part.target.name}\n`;
    });
    
    scad += '}\n';
    
    return scad;
}

function hexToRgb(hex: string): { r: number, g: number, b: number } {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : { r: 0, g: 0, b: 0 };
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-zA-Z0-9_-]/g, '_');
}

async function loadJSZip(): Promise<void> {
    if (typeof JSZip !== "undefined") {
        return;
    }
    
    return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
        script.onload = () => resolve();
        script.onerror = () => reject(new Error("Failed to load JSZip"));
        document.head.appendChild(script);
    });
}
