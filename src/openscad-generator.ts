import { PartListImage } from "./image-utils";
import JSZip from "jszip";

export async function generateOpenSCADMasks(image: PartListImage, settings: { pitch: number; height: number }) {
    const { pixels, width, height, partList } = image;
    const { pitch, height: blockHeight } = settings;
    
    const zip = new JSZip();
    
    // Create a mask image for each color
    const imagePromises = partList.map((part, index) => {
        return new Promise<void>((resolve) => {
            // Create a canvas for this color's mask
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d')!;
            
            // Fill with white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
            
            // Draw black pixels where this color appears
            ctx.fillStyle = 'black';
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    if (pixels[y][x] === index) {
                        ctx.fillRect(x, y, 1, 1);
                    }
                }
            }
            
            // Convert canvas to PNG blob
            canvas.toBlob((blob) => {
                if (blob) {
                    const filename = `color_${index}_${sanitizeFilename(part.target.name)}.png`;
                    zip.file(filename, blob);
                }
                resolve();
            }, 'image/png');
        });
    });
    
    // Wait for all images to be created
    await Promise.all(imagePromises);
    
    // Generate the OpenSCAD file
    const scadLines: string[] = [];
    scadLines.push(`// Generated by Firaga.io`);
    scadLines.push(`// Image dimensions: ${width}x${height}`);
    scadLines.push(`// Pitch: ${pitch}mm, Height: ${blockHeight}mm`);
    scadLines.push(``);
    scadLines.push(`pitch = ${pitch};`);
    scadLines.push(`block_height = ${blockHeight};`);
    scadLines.push(``);
    
    partList.forEach((part, index) => {
        const filename = `color_${index}_${sanitizeFilename(part.target.name)}.png`;
        const colorName = sanitizeFilename(part.target.name).replace(/[^a-zA-Z0-9_]/g, '_');
        
        scadLines.push(`// ${part.target.name}`);
        scadLines.push(`module layer_${colorName}() {`);
        scadLines.push(`  surface(file = "${filename}", center = true, invert = true);`);
        scadLines.push(`  scale([pitch, pitch, block_height])`);
        scadLines.push(`    surface(file = "${filename}", center = false, invert = true);`);
        scadLines.push(`}`);
        scadLines.push(``);
    });
    
    scadLines.push(`// Combine all layers`);
    scadLines.push(`union() {`);
    partList.forEach((part, index) => {
        const colorName = sanitizeFilename(part.target.name).replace(/[^a-zA-Z0-9_]/g, '_');
        scadLines.push(`  layer_${colorName}();`);
    });
    scadLines.push(`}`);
    
    const scadContent = scadLines.join('\n');
    zip.file('model.scad', scadContent);
    
    // Generate the zip file and download
    const zipBlob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(zipBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'openscad_masks.zip';
    a.click();
    URL.revokeObjectURL(url);
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase();
}
