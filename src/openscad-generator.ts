import { PartListImage } from "./image-utils";
import { ThreeDExportSettings } from "./components/3d-export-dialog";
import { saveAs } from "file-saver";
import JSZip from "jszip";

export async function generateOpenSCADMasks(image: PartListImage, settings: ThreeDExportSettings) {
    const zip = new JSZip();
    
    const depth = 2.0; // Depth of each layer in mm
    const pixelSize = settings.pitch * 25.4; // Convert inches to mm
    
    // Create a monochrome image for each color
    const imagePromises = image.partList.map((part, colorIdx) => {
        return createMaskImage(image, colorIdx);
    });
    
    const maskImages = await Promise.all(imagePromises);
    
    // Add mask images to ZIP
    maskImages.forEach((imageData, idx) => {
        const part = image.partList[idx];
        const filename = `mask_${idx}_${sanitizeFilename(part.target.name)}.png`;
        zip.file(filename, imageData);
    });
    
    // Generate OpenSCAD file
    const scadContent = generateOpenSCADFile(image, settings, depth, pixelSize);
    zip.file(`${settings.filename}.scad`, scadContent);
    
    // Generate the ZIP file and save it
    const blob = await zip.generateAsync({ type: "blob" });
    saveAs(blob, `${settings.filename}_openscad.zip`);
}

async function createMaskImage(image: PartListImage, colorIdx: number): Promise<Blob> {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = image.width;
        canvas.height = image.height;
        const ctx = canvas.getContext('2d')!;
        
        // Fill with white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, image.width, image.height);
        
        // Draw black pixels where this color appears
        ctx.fillStyle = 'black';
        for (let y = 0; y < image.height; y++) {
            for (let x = 0; x < image.width; x++) {
                if (image.pixels[y][x] === colorIdx) {
                    ctx.fillRect(x, y, 1, 1);
                }
            }
        }
        
        canvas.toBlob((blob) => {
            resolve(blob!);
        }, 'image/png');
    });
}

function generateOpenSCADFile(
    image: PartListImage,
    settings: ThreeDExportSettings,
    depth: number,
    pixelSize: number
): string {
    let scad = `// Generated by firaga.io
// Image: ${settings.filename}
// Size: ${image.width}x${image.height}

pixel_size = ${pixelSize}; // mm per pixel
layer_depth = ${depth}; // mm per layer
image_width = ${image.width};
image_height = ${image.height};

`;
    
    // Add a module for each color layer
    image.partList.forEach((part, idx) => {
        const filename = `mask_${idx}_${sanitizeFilename(part.target.name)}.png`;
        const r = part.target.r / 255;
        const g = part.target.g / 255;
        const b = part.target.b / 255;
        
        scad += `// ${part.target.name}\n`;
        scad += `module layer_${idx}() {\n`;
        scad += `    color([${r}, ${g}, ${b}])\n`;
        scad += `    scale([pixel_size, pixel_size, layer_depth])\n`;
        scad += `    surface(file = "${filename}", center = false, invert = true);\n`;
        scad += `}\n\n`;
    });
    
    // Create the main assembly
    scad += `// Main assembly - all layers\n`;
    scad += `union() {\n`;
    image.partList.forEach((part, idx) => {
        scad += `    translate([0, 0, ${idx * depth}])\n`;
        scad += `        layer_${idx}();\n`;
    });
    scad += `}\n`;
    
    return scad;
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-zA-Z0-9_-]/g, '_');
}
