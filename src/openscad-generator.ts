import { PartListImage } from "./image-utils";
import { saveAs } from "file-saver";

export type OpenSCADSettings = {
    heightPerLayer: number;
    baseHeight: number;
    pixelSize: number;
};

export async function generateOpenSCADMasks(image: PartListImage, settings: OpenSCADSettings, filename: string) {
    // We'll create individual files for now since JSZip is not available
    // Download each mask image
    for (let colorIdx = 0; colorIdx < image.partList.length; colorIdx++) {
        const part = image.partList[colorIdx];
        const maskCanvas = createMaskImage(image, colorIdx);
        const blob = await new Promise<Blob>((resolve) => {
            maskCanvas.toBlob((b) => resolve(b!), 'image/png');
        });
        
        const colorName = sanitizeFilename(part.target.name);
        saveAs(blob, `${filename}_mask_${colorIdx}_${colorName}.png`);
    }
    
    // Create and download OpenSCAD file
    const scadContent = generateSCADFile(image, settings, filename);
    const scadBlob = new Blob([scadContent], { type: 'text/plain' });
    saveAs(scadBlob, `${filename}.scad`);
}

function createMaskImage(image: PartListImage, colorIdx: number): HTMLCanvasElement {
    const canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    const ctx = canvas.getContext('2d')!;
    
    // Fill with white (transparent areas)
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, image.width, image.height);
    
    // Draw black pixels where this color exists
    ctx.fillStyle = 'black';
    for (let y = 0; y < image.height; y++) {
        for (let x = 0; x < image.width; x++) {
            if (image.pixels[y][x] === colorIdx) {
                ctx.fillRect(x, y, 1, 1);
            }
        }
    }
    
    return canvas;
}

function generateSCADFile(image: PartListImage, settings: OpenSCADSettings, filename: string): string {
    const { heightPerLayer, baseHeight, pixelSize } = settings;
    
    let scad = `// Generated by firaga.io
// Image size: ${image.width}x${image.height} pixels
// Pixel size: ${pixelSize}mm
// Base height: ${baseHeight}mm
// Height per layer: ${heightPerLayer}mm
//
// Place all mask images in the same directory as this .scad file

`;

    // Add module for each color layer
    for (let colorIdx = 0; colorIdx < image.partList.length; colorIdx++) {
        const part = image.partList[colorIdx];
        const colorName = sanitizeFilename(part.target.name);
        const r = part.target.r / 255;
        const g = part.target.g / 255;
        const b = part.target.b / 255;
        
        scad += `// Color: ${part.target.name}
module layer_${colorIdx}() {
    color([${r.toFixed(3)}, ${g.toFixed(3)}, ${b.toFixed(3)}])
    translate([0, 0, ${baseHeight}])
    scale([${pixelSize}, ${pixelSize}, ${heightPerLayer}])
    surface(file = "${filename}_mask_${colorIdx}_${colorName}.png", center = false, invert = true);
}

`;
    }
    
    // Combine all layers
    scad += `// Base
module base() {
    color([0.5, 0.5, 0.5])
    cube([${image.width * pixelSize}, ${image.height * pixelSize}, ${baseHeight}]);
}

// Complete model
base();
`;
    
    for (let colorIdx = 0; colorIdx < image.partList.length; colorIdx++) {
        scad += `layer_${colorIdx}();\n`;
    }
    
    return scad;
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-zA-Z0-9_-]/g, '_');
}
