import { PartListImage } from "./image-utils";
import { saveAs } from "file-saver";

export type OpenSCADSettings = {
    filename: string;
    pixelHeight: number;
    pixelWidth: number;
};

export async function generateOpenSCADMasks(image: PartListImage, settings: OpenSCADSettings) {
    // Load JSZip dynamically from CDN
    const JSZip = await loadJSZip();
    const zip = new JSZip();
    const { width, height, partList, pixels } = image;
    
    // Create a black/white image for each color
    const imagePromises = partList.map(async (part, colorIndex) => {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        
        if (!ctx) return;
        
        // Fill with white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, width, height);
        
        // Draw black pixels where this color appears
        ctx.fillStyle = 'black';
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                if (pixels[y][x] === colorIndex) {
                    ctx.fillRect(x, y, 1, 1);
                }
            }
        }
        
        // Convert to PNG blob
        return new Promise<void>((resolve) => {
            canvas.toBlob((blob) => {
                if (blob) {
                    const filename = `color_${colorIndex}_${sanitizeFilename(part.target.name)}.png`;
                    zip.file(filename, blob);
                }
                resolve();
            });
        });
    });
    
    await Promise.all(imagePromises);
    
    // Create OpenSCAD file
    const scadContent = generateSCADFile(image, settings);
    zip.file(`${settings.filename}.scad`, scadContent);
    
    // Generate and download zip file
    const zipBlob = await zip.generateAsync({ type: 'blob' });
    saveAs(zipBlob, `${settings.filename}_openscad.zip`);
}

async function loadJSZip(): Promise<any> {
    const tagName = "jszip-script-tag";
    // Load JSZip from CDN if it's not already loaded
    if (typeof (window as any).JSZip !== "undefined") {
        return (window as any).JSZip;
    }
    
    return new Promise((resolve, reject) => {
        const scriptEl = document.getElementById(tagName);
        if (scriptEl === null) {
            const tag = document.createElement("script");
            tag.id = tagName;
            tag.onload = () => {
                resolve((window as any).JSZip);
            };
            tag.onerror = reject;
            tag.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
            document.head.appendChild(tag);
        } else {
            resolve((window as any).JSZip);
        }
    });
}

function generateSCADFile(image: PartListImage, settings: OpenSCADSettings): string {
    const { width, height, partList } = image;
    const { pixelHeight, pixelWidth } = settings;
    
    let scadContent = `// Generated by firaga.io
// Image dimensions: ${width}x${height}
// Pixel size: ${pixelWidth}mm x ${pixelWidth}mm
// Pixel height: ${pixelHeight}mm

`;
    
    // Add each color layer
    partList.forEach((part, colorIndex) => {
        const filename = `color_${colorIndex}_${sanitizeFilename(part.target.name)}.png`;
        const r = (part.target.r / 255).toFixed(3);
        const g = (part.target.g / 255).toFixed(3);
        const b = (part.target.b / 255).toFixed(3);
        
        scadContent += `// ${part.target.name} (${part.count} pixels)
color([${r}, ${g}, ${b}])
  scale([${pixelWidth}, ${pixelWidth}, ${pixelHeight}])
    surface(file = "${filename}", center = true, invert = true);

`;
    });
    
    // Add union of all layers
    scadContent += `// Combined view
union() {
`;
    
    partList.forEach((part, colorIndex) => {
        const filename = `color_${colorIndex}_${sanitizeFilename(part.target.name)}.png`;
        const r = (part.target.r / 255).toFixed(3);
        const g = (part.target.g / 255).toFixed(3);
        const b = (part.target.b / 255).toFixed(3);
        
        scadContent += `  color([${r}, ${g}, ${b}])
    scale([${pixelWidth}, ${pixelWidth}, ${pixelHeight}])
      surface(file = "${filename}", center = true, invert = true);
`;
    });
    
    scadContent += `}
`;
    
    return scadContent;
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}
