import { PartListImage } from "./image-utils";

declare const JSZip: any;

/**
 * Generates a ZIP file containing:
 * - Monochrome PNG images (one per color) showing which pixels are filled
 * - An OpenSCAD file that loads and combines these images into a 3D display
 */
export async function generateOpenSCADMasks(image: PartListImage, heightMm: number, filename: string): Promise<void> {
    await loadJSZipAnd(() => generateOpenSCADMasksWorker(image, heightMm, filename));
}

async function loadJSZipAnd(func: () => void): Promise<void> {
    const tagName = "jszip-script-tag";
    const scriptEl = document.getElementById(tagName);
    if (scriptEl === null) {
        const tag = document.createElement("script");
        tag.id = tagName;
        tag.onload = () => func();
        tag.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
        document.head.appendChild(tag);
    } else {
        func();
    }
}

function generateOpenSCADMasksWorker(image: PartListImage, heightMm: number, filename: string): void {
    const zip = new JSZip();
    const pixelSizeMm = 1.0;
    
    // Generate PNG mask for each color
    const imageFiles: Array<{ name: string; colorName: string; symbol: string }> = [];
    
    for (let colorIdx = 0; colorIdx < image.partList.length; colorIdx++) {
        const color = image.partList[colorIdx];
        const maskCanvas = createMaskImage(image, colorIdx);
        const pngName = `mask_${color.symbol}_${sanitizeFilename(color.target.name)}.png`;
        
        // Convert canvas to blob and add to zip
        maskCanvas.toBlob((blob: Blob | null) => {
            if (blob) {
                zip.file(pngName, blob);
            }
        });
        
        imageFiles.push({
            name: pngName,
            colorName: color.target.name,
            symbol: color.symbol
        });
    }
    
    // Generate OpenSCAD file
    const scadContent = generateOpenSCADFile(image, imageFiles, heightMm, pixelSizeMm);
    zip.file(`${filename}.scad`, scadContent);
    
    // Generate README
    const readmeContent = generateReadme(imageFiles);
    zip.file("README.txt", readmeContent);
    
    // Generate and download ZIP
    setTimeout(() => {
        zip.generateAsync({ type: "blob" }).then((blob: Blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_openscad.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }, 100); // Small delay to ensure all canvas.toBlob callbacks complete
}

function createMaskImage(image: PartListImage, colorIdx: number): HTMLCanvasElement {
    const canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    const ctx = canvas.getContext('2d');
    
    if (!ctx) throw new Error('Could not get canvas context');
    
    const imageData = ctx.createImageData(image.width, image.height);
    
    for (let y = 0; y < image.height; y++) {
        for (let x = 0; x < image.width; x++) {
            const idx = (y * image.width + x) * 4;
            const isThisColor = image.pixels[y][x] === colorIdx;
            
            // White for this color, black otherwise
            const value = isThisColor ? 255 : 0;
            imageData.data[idx] = value;
            imageData.data[idx + 1] = value;
            imageData.data[idx + 2] = value;
            imageData.data[idx + 3] = 255;
        }
    }
    
    ctx.putImageData(imageData, 0, 0);
    return canvas;
}

function generateOpenSCADFile(
    image: PartListImage,
    imageFiles: Array<{ name: string; colorName: string; symbol: string }>,
    heightMm: number,
    pixelSizeMm: number
): string {
    const width = image.width * pixelSizeMm;
    const depth = image.height * pixelSizeMm;
    
    let scadContent = `// OpenSCAD file generated by firaga.io
// Image dimensions: ${image.width}x${image.height} pixels
// Physical size: ${width}mm x ${depth}mm
// Block height: ${heightMm}mm

`;
    
    // Add color modules
    for (const imgFile of imageFiles) {
        const color = image.partList.find(p => p.symbol === imgFile.symbol);
        if (!color) continue;
        
        const r = (color.target.r / 255).toFixed(3);
        const g = (color.target.g / 255).toFixed(3);
        const b = (color.target.b / 255).toFixed(3);
        
        scadContent += `// ${imgFile.colorName} (${imgFile.symbol})
module layer_${imgFile.symbol}() {
    color([${r}, ${g}, ${b}])
    surface(file = "${imgFile.name}", center = true, invert = true);
}

`;
    }
    
    // Combine all layers
    scadContent += `// Combine all layers
union() {
`;
    
    for (const imgFile of imageFiles) {
        scadContent += `    scale([${pixelSizeMm}, ${pixelSizeMm}, ${heightMm}])
        layer_${imgFile.symbol}();
`;
    }
    
    scadContent += `}
`;
    
    return scadContent;
}

function generateReadme(imageFiles: Array<{ name: string; colorName: string; symbol: string }>): string {
    let readme = `OpenSCAD 3D Export from firaga.io
=====================================

This ZIP file contains:
1. ${imageFiles.length} monochrome mask images (one per color)
2. An OpenSCAD file (.scad) that combines them into a 3D model

Files:
`;
    
    for (const img of imageFiles) {
        readme += `  - ${img.name} (${img.colorName})\n`;
    }
    
    readme += `
To use:
1. Extract all files to the same directory
2. Open the .scad file in OpenSCAD (https://openscad.org/)
3. Press F5 to preview or F6 to render
4. Export as STL for 3D printing

Note: Each mask image is a heightmap where white pixels create raised areas.
`;
    
    return readme;
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-zA-Z0-9_-]/g, '_');
}
