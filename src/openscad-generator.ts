import { PartListImage } from "./image-utils";
import { colorEntryToHex } from "./utils";

declare const JSZip: any;

export type OpenSCADSettings = {
    heightPerColor: number;
    pixelSize: number;
    baseHeight: number;
};

export async function generateOpenSCADMasks(image: PartListImage, settings: OpenSCADSettings): Promise<Blob> {
    await loadJSZip();
    
    const zip = new JSZip();
    const { heightPerColor, pixelSize, baseHeight } = settings;
    
    // Generate one mask image per color
    const masks: Array<{ name: string, canvas: HTMLCanvasElement }> = [];
    
    image.partList.forEach((part, colorIndex) => {
        const canvas = document.createElement('canvas');
        canvas.width = image.width;
        canvas.height = image.height;
        const ctx = canvas.getContext('2d')!;
        
        // Fill with white (background)
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw black pixels for this color
        ctx.fillStyle = 'black';
        for (let y = 0; y < image.height; y++) {
            for (let x = 0; x < image.width; x++) {
                if (image.pixels[y][x] === colorIndex) {
                    ctx.fillRect(x, y, 1, 1);
                }
            }
        }
        
        masks.push({
            name: `color_${colorIndex}_${sanitizeFilename(part.target.name)}.png`,
            canvas
        });
    });
    
    // Add mask images to zip
    for (const mask of masks) {
        const dataUrl = mask.canvas.toDataURL('image/png');
        const base64Data = dataUrl.split(',')[1];
        zip.file(mask.name, base64Data, { base64: true });
    }
    
    // Generate OpenSCAD file
    const scadContent = generateOpenSCADFile(image, masks.map(m => m.name), settings);
    zip.file('model.scad', scadContent);
    
    // Generate readme
    const readmeContent = `Pixel Art 3D Model - OpenSCAD Masks
Generated by firaga.io

This archive contains:
- model.scad: OpenSCAD file that builds the 3D model
- *.png: Mask images for each color (black = filled, white = empty)

To use:
1. Install OpenSCAD (https://openscad.org/)
2. Open model.scad in OpenSCAD
3. Press F5 to preview or F6 to render
4. Export as STL for 3D printing

Settings:
- Pixel size: ${pixelSize}mm
- Height per color: ${heightPerColor}mm
- Base height: ${baseHeight}mm
`;
    zip.file('README.txt', readmeContent);
    
    return await zip.generateAsync({ type: 'blob' });
}

function generateOpenSCADFile(image: PartListImage, maskFiles: string[], settings: OpenSCADSettings): string {
    const { heightPerColor, pixelSize, baseHeight } = settings;
    
    let scadCode = `// Pixel Art 3D Model
// Generated by firaga.io
// Image size: ${image.width}x${image.height} pixels

pixel_size = ${pixelSize}; // mm
height_per_color = ${heightPerColor}; // mm
base_height = ${baseHeight}; // mm

module color_layer(mask_file, z_offset) {
    translate([0, 0, z_offset])
    scale([pixel_size, pixel_size, height_per_color])
    surface(file = mask_file, center = false, invert = true);
}

union() {
    // Base layer
    if (base_height > 0) {
        cube([${image.width} * pixel_size, ${image.height} * pixel_size, base_height]);
    }
    
    // Color layers
`;
    
    maskFiles.forEach((maskFile, index) => {
        const colorName = image.partList[index].target.name;
        scadCode += `    // ${colorName}\n`;
        scadCode += `    color_layer("${maskFile}", base_height);\n`;
        scadCode += `\n`;
    });
    
    scadCode += `}
`;
    
    return scadCode;
}

function sanitizeFilename(name: string): string {
    return name.replace(/[^a-zA-Z0-9_-]/g, '_');
}

async function loadJSZip(): Promise<void> {
    if (typeof JSZip !== 'undefined') {
        return;
    }
    
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Failed to load JSZip'));
        document.head.appendChild(script);
    });
}
