import { PartListImage } from "./image-utils";
import { colorEntryToHex } from "./utils";

declare const JSZip: any;

export async function generateOpenSCADMasks(
    image: PartListImage, 
    filename: string,
    heightPerLayer: number
): Promise<void> {
    await loadJSZip();
    
    const zip = new JSZip();
    
    // Generate one PNG mask per color
    const imagePromises = image.partList.map(async (part, colorIdx) => {
        const maskCanvas = createMaskImage(image, colorIdx);
        const blob = await canvasToBlob(maskCanvas);
        const colorName = sanitizeFilename(part.target.name);
        zip.file(`mask_${colorIdx}_${colorName}.png`, blob);
        return { colorIdx, colorName, color: part.target };
    });
    
    const colorData = await Promise.all(imagePromises);
    
    // Generate OpenSCAD file
    const scadContent = generateOpenSCADFile(image, colorData, heightPerLayer);
    zip.file(`${filename}.scad`, scadContent);
    
    // Generate the ZIP file
    const zipBlob = await zip.generateAsync({ type: 'blob' });
    downloadFile(zipBlob, `${filename}_openscad.zip`);
}

function createMaskImage(image: PartListImage, colorIdx: number): HTMLCanvasElement {
    const canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    const ctx = canvas.getContext('2d')!;
    
    // Fill with black background
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, image.width, image.height);
    
    // Set white pixels where this color appears
    ctx.fillStyle = '#FFFFFF';
    for (let y = 0; y < image.height; y++) {
        for (let x = 0; x < image.width; x++) {
            if (image.pixels[y][x] === colorIdx) {
                ctx.fillRect(x, y, 1, 1);
            }
        }
    }
    
    return canvas;
}

function canvasToBlob(canvas: HTMLCanvasElement): Promise<Blob> {
    return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
            if (blob) {
                resolve(blob);
            } else {
                reject(new Error('Failed to create blob from canvas'));
            }
        }, 'image/png');
    });
}

type ColorData = {
    colorIdx: number;
    colorName: string;
    color: { name: string; r: number; g: number; b: number };
};

function generateOpenSCADFile(
    image: PartListImage,
    colorData: ColorData[],
    heightPerLayer: number
): string {
    const pixelSize = 1.0; // 1mm per pixel
    
    const modules = colorData.map(({ colorIdx, colorName, color }) => {
        const r = (color.r / 255).toFixed(3);
        const g = (color.g / 255).toFixed(3);
        const b = (color.b / 255).toFixed(3);
        
        return `// ${color.name}
module layer_${colorIdx}() {
    color([${r}, ${g}, ${b}])
    translate([0, 0, ${(colorIdx * heightPerLayer).toFixed(3)}])
    surface(file = "mask_${colorIdx}_${colorName}.png", 
            center = true, 
            invert = false,
            convexity = 10);
}`;
    }).join('\n\n');
    
    const calls = colorData.map(({ colorIdx }) => 
        `    scale([${pixelSize}, ${pixelSize}, ${heightPerLayer}]) layer_${colorIdx}();`
    ).join('\n');
    
    return `// Generated by firaga.io
// Image: ${image.width}x${image.height} pixels
// Layers: ${colorData.length}
// Height per layer: ${heightPerLayer}mm

${modules}

// Combine all layers
union() {
${calls}
}
`;
}

function sanitizeFilename(name: string): string {
    return name
        .replace(/[^a-zA-Z0-9_-]/g, '_')
        .replace(/_+/g, '_')
        .toLowerCase();
}

function downloadFile(blob: Blob, filename: string): void {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

async function loadJSZip(): Promise<void> {
    const tagName = "jszip-script-tag";
    const scriptEl = document.getElementById(tagName);
    
    if (scriptEl === null) {
        return new Promise((resolve, reject) => {
            const tag = document.createElement("script");
            tag.id = tagName;
            tag.onload = () => resolve();
            tag.onerror = () => reject(new Error('Failed to load JSZip'));
            tag.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
            document.head.appendChild(tag);
        });
    }
}
