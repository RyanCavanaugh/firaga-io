import { PartListImage } from "./image-utils";
import { saveAs } from "file-saver";

// JSZip will be loaded dynamically from CDN
declare const JSZip: any;

export interface OpenSCADSettings {
  pixelHeight: number;
  baseHeight: number;
}

/**
 * Generate a zip file containing:
 * - one monochrome (black/white) image per color
 * - an openscad file that loads all images and combines them into a 3d display
 */
export async function generateOpenSCADMasks(
  image: PartListImage,
  settings: OpenSCADSettings,
  filename: string
): Promise<void> {
  await loadJSZip();
  const zip = new JSZip();
  const { pixelHeight, baseHeight } = settings;

  // Create mask images for each color
  const maskFiles: string[] = [];
  for (let i = 0; i < image.partList.length; i++) {
    const part = image.partList[i];
    const maskFilename = `mask_${i}_${sanitizeFilename(part.target.name)}.png`;
    maskFiles.push(maskFilename);

    const maskImageData = createMaskImage(image, i);
    const maskBlob = await canvasToBlob(maskImageData);
    zip.file(maskFilename, maskBlob);
  }

  // Create the OpenSCAD file
  const scadContent = generateSCADFile(image, maskFiles, settings);
  zip.file(`${filename}.scad`, scadContent);

  // Generate and save the zip file
  const blob = await zip.generateAsync({ type: "blob" });
  saveAs(blob, `${filename}_openscad.zip`);
}

function createMaskImage(image: PartListImage, colorIndex: number): ImageData {
  const canvas = document.createElement("canvas");
  canvas.width = image.width;
  canvas.height = image.height;
  const ctx = canvas.getContext("2d");
  if (!ctx) throw new Error("Failed to get canvas context");

  const imageData = ctx.createImageData(image.width, image.height);

  for (let y = 0; y < image.height; y++) {
    for (let x = 0; x < image.width; x++) {
      const idx = (y * image.width + x) * 4;
      const isColor = image.pixels[y][x] === colorIndex;
      const value = isColor ? 0 : 255; // Black for filled, white for empty

      imageData.data[idx] = value;     // R
      imageData.data[idx + 1] = value; // G
      imageData.data[idx + 2] = value; // B
      imageData.data[idx + 3] = 255;   // A
    }
  }

  return imageData;
}

async function canvasToBlob(imageData: ImageData): Promise<Blob> {
  const canvas = document.createElement("canvas");
  canvas.width = imageData.width;
  canvas.height = imageData.height;
  const ctx = canvas.getContext("2d");
  if (!ctx) throw new Error("Failed to get canvas context");
  
  ctx.putImageData(imageData, 0, 0);

  return new Promise<Blob>((resolve, reject) => {
    canvas.toBlob((blob) => {
      if (blob) {
        resolve(blob);
      } else {
        reject(new Error("Failed to create blob from canvas"));
      }
    }, "image/png");
  });
}

function generateSCADFile(
  image: PartListImage,
  maskFiles: string[],
  settings: OpenSCADSettings
): string {
  const { pixelHeight, baseHeight } = settings;
  
  const colorModules = image.partList.map((part, idx) => {
    const r = part.target.r / 255;
    const g = part.target.g / 255;
    const b = part.target.b / 255;
    const maskFile = maskFiles[idx];
    
    return `// ${part.target.name} (${part.count} pixels)
module color_${idx}() {
    color([${r.toFixed(3)}, ${g.toFixed(3)}, ${b.toFixed(3)}])
    translate([0, 0, ${baseHeight}])
    surface(file = "${maskFile}", invert = true, center = true);
}`;
  }).join('\n\n');

  const unionCalls = image.partList.map((_, idx) => `    color_${idx}();`).join('\n');

  return `// Generated by firaga.io
// Image size: ${image.width}x${image.height}
// Pixel height: ${pixelHeight}mm
// Base height: ${baseHeight}mm

$fn = 50; // Smoothness parameter

${colorModules}

// Combine all color layers
union() {
${unionCalls}
}
`;
}

function sanitizeFilename(name: string): string {
  return name.replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase();
}

async function loadJSZip(): Promise<void> {
  const tagName = "jszip-script-tag";
  if (document.getElementById(tagName)) return;

  return new Promise<void>((resolve, reject) => {
    const tag = document.createElement("script");
    tag.id = tagName;
    tag.onload = () => resolve();
    tag.onerror = () => reject(new Error("Failed to load JSZip"));
    tag.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
    document.head.appendChild(tag);
  });
}
